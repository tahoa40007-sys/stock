<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CB Watchlist（雲端版）</title>

  <link rel="stylesheet" href="./styles.css" />
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#111827">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

</head>
<body>
  <header class="topbar">
    <div class="title">
      <div class="h1">CB Watchlist</div>
      <div class="sub">Google Drive 雲端資料｜欄位勾選・排序・釘選・Watchlist</div>
    </div>
    <div class="actions">
      <button id="btnSettings">資料來源</button>
      <button id="btnRefresh">更新資料</button>
    </div>
  </header>

  <section class="panel">
    <div class="row">
      <div class="card">
        <div class="cardTitle">Watchlist</div>
        <div class="row">
          <input id="inpAdd" placeholder="輸入債券代號，例如 64422" />
          <button id="btnAdd">新增</button>
        </div>
        <div class="chips" id="watchChips"></div>
        <div class="hint">Watchlist 存在手機本機（LocalStorage）。之後要多人/多裝置同步，我們再做「雲端 watchlist」。</div>
      </div>

      <div class="card">
        <div class="cardTitle">排序</div>
        <div class="row">
          <select id="selSortKey"></select>
          <select id="selSortDir">
            <option value="desc">由大到小</option>
            <option value="asc">由小到大</option>
          </select>
          <button id="btnApplySort">套用</button>
        </div>
        <div class="hint">也可以直接點表格標題排序。</div>
      </div>

      <div class="card">
        <div class="cardTitle">顯示欄位 / 釘選</div>
        <div class="cols" id="colChooser"></div>
        <div class="hint">⭐ 代表「釘選」，會顯示在最左邊。</div>
      </div>
    </div>
  </section>

  <main class="main">
    <div id="status" class="status">尚未載入資料</div>
    <div class="tableWrap">
      <table id="tbl"></table>
    </div>
  </main>

  <dialog id="dlgSettings">
    <form method="dialog" class="dlg">
      <div class="dlgTitle">資料來源設定（Google Drive API）</div>
      <div class="dlgBody">
        <label>Drive API Key（Google Cloud 建 API key，並啟用 Google Drive API）</label>
        <input id="inpApiKey" placeholder="AIza..." />
        <label>檔案 ID（cb_snapshot_latest_all.json.gz 的 file id）</label>
        <input id="inpFileId" placeholder="1AbCDefG..." />
        <div class="hint">
          本頁會用 <code>https://www.googleapis.com/drive/v3/files/{fileId}?alt=media&key=API_KEY</code> 下載檔案內容。<br/>
          你的 Drive 檔案需設定成「知道連結的人可檢視」或公開。
        </div>
      </div>
      <div class="dlgActions">
        <button value="cancel">取消</button>
        <button id="btnSave" value="ok">儲存</button>
      </div>
    </form>
  </dialog>

  <script src="./app.js"></script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        await navigator.serviceWorker.register("./service-worker.js");
        // 第一次部署後，通常要重新整理一次才會被 SW 控制到（正常）
      } catch (e) {
        console.warn("Service Worker 註冊失敗：", e);
      }
    });
  }
</script>  
<script src="./app.js"></script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js");
    });
  }
</script>
</body>
</html>
